From a225beca6ffca0fe455ed9422e26bff5ee36c651 Mon Sep 17 00:00:00 2001
From: Adrian Muzyka <adrian.muzyka.it@gmail.com>
Date: Tue, 13 Jan 2026 11:50:07 +0100
Subject: [PATCH] RDK-54059: retry ptrace seize on EPERM

---
 memcr.c | 10 ++++++++++
 1 file changed, 10 insertions(+)

diff --git a/memcr.c b/memcr.c
index 526164f..94474b5 100644
--- a/memcr.c
+++ b/memcr.c
@@ -252,6 +252,7 @@ static int checkpoint_service_socket = SOCKET_INVALID;
 #define FALSE		0
 
 #define MAX_CLIENT_CONNECTIONS		8
+#define PTRACE_SEIZE_RETRY_MAX         3
 
 struct service_command_ctx {
 	struct service_command svc_cmd;
@@ -534,13 +535,22 @@ static int seize_pid(pid_t pid)
 	int ret;
 	int status;
 	siginfo_t si;
+	int cnt = 0;
 
+ptrace_seize_retry:
 	ret = ptrace(PTRACE_SEIZE, pid, NULL, 0);
 	if (ret) {
 		if (errno == ESRCH) {
 			err("ptrace(PTRACE_SEIZE) pid %d: %m, ignoring\n", pid);
 			return 0;
 		}
+		else if (errno == EPERM) {
+			if (cnt++ < PTRACE_SEIZE_RETRY_MAX)	{
+				err("ptrace(PTRACE_SEIZE) errno %d retry %d pid %d: %m\n", errno, cnt, pid);
+				usleep(100 * 1000); // 100 milliseconds
+				goto ptrace_seize_retry;
+			}
+		}
 
 		err("ptrace(PTRACE_SEIZE) %d pid %d: %m\n", errno, pid);
 		return 1;
-- 
2.43.0

